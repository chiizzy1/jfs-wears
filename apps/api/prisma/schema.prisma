// JFS Wears - Database Schema
// Prisma ORM for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  phone                 String?   @unique
  name                  String?
  passwordHash          String?
  profileImage          String?   // URL to user's profile image
  isVerified            Boolean   @default(false)
  verificationToken     String?   // Token for email verification
  verificationExpires   DateTime? // Token expiry time
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?

  addresses     Address[]
  orders        Order[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]
  reviews       Review[]

  @@map("users")
  @@index([email])
  @@index([phone])
  refreshTokens RefreshToken[]
}

model RefreshToken {
  id          String   @id @default(cuid())
  tokenHash   String   @unique
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  staffId     String?
  staff       Staff?   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  isRevoked   Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  
  @@map("refresh_tokens")
  @@index([userId])
  @@index([staffId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  @@map("password_reset_tokens")
  @@index([token])
  @@index([userId])
}

model Staff {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  passwordHash String
  profileImage String?   // URL to staff profile image
  role         StaffRole @default(STAFF)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  @@map("staff")
  refreshTokens RefreshToken[]
}

enum StaffRole {
  ADMIN
  MANAGER
  STAFF
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName   String
  lastName    String
  phone       String
  address     String
  city        String
  state       String
  landmark    String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("addresses")
}

// ============================================
// PRODUCTS & CATEGORIES
// ============================================

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  imageUrl    String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  position    Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products           Product[]
  heroSlides         StorefrontHero[]
  storefrontSections StorefrontSection[]

  @@map("categories")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  basePrice   Decimal  @db.Decimal(10, 2)
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  
  tags        String[] @default([]) // For "latest", "new", etc.
  gender      Gender   @default(UNISEX)
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  variants        ProductVariant[]
  images          ProductImage[]
  reviews         Review[]
  cartItems       CartItem[]
  wishlistItems   WishlistItem[]
  orderItems      OrderItem[]
  heroSlides      StorefrontHero[]

  @@map("products")
  @@index([slug])
  @@index([categoryId])
  @@index([gender])
}

enum Gender {
  MEN
  WOMEN
  UNISEX
}

model ProductVariant {
  id              String   @id @default(cuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  size            String?
  color           String?
  sku             String   @unique
  stock           Int      @default(0)
  priceAdjustment Decimal  @default(0) @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@unique([productId, size, color])
  @@map("product_variants")
  @@index([sku])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  url       String
  altText   String?
  position  Int      @default(0)
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("product_images")
}

model Review {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  rating    Int      // 1-5
  title     String?
  comment   String?
  isVerified Boolean @default(false) // Verified purchase
  isApproved Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([productId, userId]) // One review per product per user
  @@map("reviews")
  @@index([productId])
  @@index([userId])
}

// ============================================
// CART & WISHLIST
// ============================================

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, variantId])
  @@map("cart_items")
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@map("wishlist_items")
}

// ============================================
// ORDERS
// ============================================

model Order {
  id               String       @id @default(cuid())
  orderNumber      String       @unique
  
  // Customer info (can be guest or registered)
  userId           String?
  user             User?        @relation(fields: [userId], references: [id])
  guestEmail       String?
  guestPhone       String?
  
  // Shipping
  shippingAddress  Json
  shippingZoneId   String
  shippingZone     ShippingZone @relation(fields: [shippingZoneId], references: [id])
  shippingFee      Decimal      @db.Decimal(10, 2)
  
  // Pricing
  subtotal         Decimal      @db.Decimal(10, 2)
  discount         Decimal      @default(0) @db.Decimal(10, 2)
  tax              Decimal?     @db.Decimal(10, 2) // Optional tax amount
  total            Decimal      @db.Decimal(10, 2)
  
  // Payment
  paymentMethod    PaymentMethod
  paymentProvider  PaymentProvider?
  paymentReference String?
  paymentStatus    PaymentStatus @default(PENDING)
  
  // Order status
  status           OrderStatus   @default(PENDING)
  statusHistory    Json?         // Array of { status, timestamp, note? }
  notes            String?
  
  // Tracking
  estimatedDeliveryDate DateTime?
  trackingNumber        String?
  carrierName           String?   // e.g., "GIG Logistics", "DHL", "KWIK"
  
  // Promo
  promotionId      String?
  promotion        Promotion?    @relation(fields: [promotionId], references: [id])
  
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?

  items            OrderItem[]

  @@map("orders")
  @@index([orderNumber])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2)
  total     Decimal  @db.Decimal(10, 2)
  
  // Snapshot of product details at time of order
  productName  String
  variantSize  String?
  variantColor String?

  @@map("order_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  OPAY_WALLET
  CASH_ON_DELIVERY
}

enum PaymentProvider {
  OPAY
  MONNIFY
  PAYSTACK
}

// ============================================
// SHIPPING
// ============================================

model ShippingZone {
  id        String   @id @default(cuid())
  name      String   @unique
  states    String[] // Array of state names
  fee       Decimal  @db.Decimal(10, 2)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]

  @@map("shipping_zones")
}

// ============================================
// PROMOTIONS
// ============================================

model Promotion {
  id           String        @id @default(cuid())
  code         String        @unique
  name         String
  description  String?
  type         PromotionType
  value        Decimal       @db.Decimal(10, 2) // Percentage or fixed amount
  minOrderAmount Decimal?    @db.Decimal(10, 2)
  maxDiscount  Decimal?      @db.Decimal(10, 2) // Cap for percentage discounts
  usageLimit   Int?
  usageCount   Int           @default(0)
  validFrom    DateTime
  validTo      DateTime
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  orders       Order[]

  @@map("promotions")
}

enum PromotionType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

// ============================================
// SETTINGS
// ============================================

model StoreSettings {
  id          String   @id @default(cuid())
  storeName   String   @default("JFS Wears")
  storeEmail  String   @default("contact@jfswears.com")
  currency    String   @default("NGN")

  // Notifications
  notifyOrder    Boolean @default(true)
  notifyLowStock Boolean @default(true)
  notifyReview   Boolean @default(false)

  updatedAt   DateTime @updatedAt

  @@map("store_settings")
}

// ============================================
// STOREFRONT CMS
// ============================================

model StorefrontHero {
  id           String    @id @default(cuid())
  headline     String
  subheadline  String?
  ctaText      String?   @default("Shop Now")
  ctaLink      String?   // Custom link, or auto-generate from relations

  // Media
  mediaUrl     String
  mediaType    MediaType @default(IMAGE)
  thumbnailUrl String?   // For video previews

  // Optional Relations (polymorphic-like)
  productId    String?
  product      Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  categoryId   String?
  category     Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Display
  order        Int       @default(0)
  isActive     Boolean   @default(true)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("storefront_heroes")
  @@index([order])
  @@index([isActive])
}

model StorefrontSection {
  id          String      @id @default(cuid())
  title       String
  subtitle    String?

  type        SectionType @default(FEATURED)
  
  // For CATEGORY type: which category to show products from
  categoryId  String?
  category    Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Optional custom media for the section (e.g., hero image for "Hoodies" section)
  mediaUrl    String?
  mediaType   MediaType?

  // Display
  order       Int         @default(0)
  isActive    Boolean     @default(true)
  maxProducts Int         @default(10) // Limit products per section

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("storefront_sections")
  @@index([order])
  @@index([isActive])
}

enum MediaType {
  IMAGE
  VIDEO
}

enum SectionType {
  FEATURED   // Shows featured/latest products
  CATEGORY   // Shows products from a specific category
  COLLECTION // Future: custom curated collection
}

