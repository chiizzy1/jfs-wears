// JFS Wears - Database Schema
// Prisma ORM for PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  phone                 String?   @unique
  name                  String?
  passwordHash          String?
  profileImage          String?   // URL to user's profile image
  isVerified            Boolean   @default(false)
  verificationToken     String?   // Token for email verification
  verificationExpires   DateTime? // Token expiry time
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?

  addresses     Address[]
  orders        Order[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]
  reviews       Review[]

  @@map("users")
  @@index([email])
  @@index([phone])
  refreshTokens RefreshToken[]
}

model RefreshToken {
  id          String   @id @default(cuid())
  tokenHash   String   @unique
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  staffId     String?
  staff       Staff?   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  isRevoked   Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  
  @@map("refresh_tokens")
  @@index([userId])
  @@index([staffId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  @@map("password_reset_tokens")
  @@index([token])
  @@index([userId])
}

model Staff {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String
  passwordHash String
  profileImage String?   // URL to staff profile image
  role         StaffRole @default(STAFF)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  @@map("staff")
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
  notifications Notification[]
}

enum StaffRole {
  ADMIN
  MANAGER
  STAFF
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName   String
  lastName    String
  phone       String
  address     String
  city        String
  state       String
  postalCode  String?
  country     String   @default("Nigeria")
  landmark    String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("addresses")
}

// ============================================
// PRODUCTS & CATEGORIES
// ============================================

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  imageUrl    String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  position    Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products           Product[]
  heroSlides         StorefrontHero[]
  storefrontSections StorefrontSection[]

  @@map("categories")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  basePrice   Decimal  @db.Decimal(10, 2)
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  
  tags        String[] @default([]) // For "latest", "new", etc.
  gender      Gender   @default(UNISEX)
  isActive    Boolean  @default(true)
  isFeatured  Boolean  @default(false)

  // Bulk/Wholesale Pricing
  bulkEnabled      Boolean           @default(false)
  bulkPricingTiers BulkPricingTier[]



  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  variants        ProductVariant[]
  images          ProductImage[]    // Legacy - kept for backward compatibility
  colorGroups     ColorGroup[]      // New: color-based image grouping
  reviews         Review[]
  cartItems       CartItem[]
  wishlistItems   WishlistItem[]
  orderItems      OrderItem[]
  heroSlides      StorefrontHero[]

  @@map("products")
  @@index([slug])
  @@index([categoryId])
  @@index([gender])
}

enum Gender {
  MEN
  WOMEN
  UNISEX
}

// Color grouping for a product - each color has its own images
model ColorGroup {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  colorName   String   // e.g., "Navy Blue", "Black"
  colorHex    String?  // e.g., "#1a237e" for visual swatch
  position    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  images      VariantImage[]
  variants    ProductVariant[]
  
  @@unique([productId, colorName])
  @@map("color_groups")
  @@index([productId])
}

// Images linked to color groups (not products directly)
model VariantImage {
  id           String     @id @default(cuid())
  colorGroupId String
  colorGroup   ColorGroup @relation(fields: [colorGroupId], references: [id], onDelete: Cascade)
  
  url          String
  altText      String?
  position     Int        @default(0)
  isMain       Boolean    @default(false)
  createdAt    DateTime   @default(now())
  
  @@map("variant_images")
  @@index([colorGroupId])
}



model ProductVariant {
  id              String   @id @default(cuid())
  productId       String
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Link to color group for color-based image display
  colorGroupId    String?
  colorGroup      ColorGroup? @relation(fields: [colorGroupId], references: [id], onDelete: SetNull)
  
  size            String?
  color           String?  // Deprecated: Use colorGroup.colorName instead. Kept for backward compatibility.
  sku             String   @unique
  stock           Int      @default(0)
  priceAdjustment Decimal  @default(0) @db.Decimal(10, 2)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@unique([productId, size, colorGroupId])
  @@map("product_variants")
  @@index([sku])
  @@index([colorGroupId])
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  url       String
  altText   String?
  position  Int      @default(0)
  isMain    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("product_images")
}

// Reusable size presets (e.g., "Clothing Sizes", "Pants Waist Sizes")
model SizePreset {
  id        String   @id @default(cuid())
  name      String   @unique  // e.g., "Clothing Sizes", "Pants Waist Sizes"
  category  String   // e.g., "CLOTHING", "SHOES", "ACCESSORIES"
  sizes     String[] // e.g., ["XS", "S", "M", "L", "XL", "XXL"]
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("size_presets")
}

// Global reusable color presets
model ColorPreset {
  id        String   @id @default(cuid())
  name      String   @unique  // e.g., "Navy Blue", "Black"
  hexCode   String   // e.g., "#1a237e"
  createdAt DateTime @default(now())
  
  @@map("color_presets")
}



model Review {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  rating    Int      // 1-5
  title     String?
  comment   String?
  isVerified Boolean @default(false) // Verified purchase
  isApproved Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([productId, userId]) // One review per product per user
  @@map("reviews")
  @@index([productId])
  @@index([userId])
}

// ============================================
// CART & WISHLIST
// ============================================

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, variantId])
  @@map("cart_items")
}

model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@map("wishlist_items")
}

// ============================================
// ORDERS
// ============================================

model Order {
  id               String       @id @default(cuid())
  orderNumber      String       @unique
  
  // Customer info (can be guest or registered)
  userId           String?
  user             User?        @relation(fields: [userId], references: [id])
  guestEmail       String?
  guestPhone       String?
  
  // Shipping
  shippingAddress  Json
  shippingZoneId   String
  shippingZone     ShippingZone @relation(fields: [shippingZoneId], references: [id])
  shippingFee      Decimal      @db.Decimal(10, 2)
  
  // Pricing
  subtotal         Decimal      @db.Decimal(10, 2)
  discount         Decimal      @default(0) @db.Decimal(10, 2)
  tax              Decimal?     @db.Decimal(10, 2) // Optional tax amount
  total            Decimal      @db.Decimal(10, 2)
  
  // Payment
  paymentMethod    PaymentMethod
  paymentProvider  PaymentProvider?
  paymentReference String?
  paymentStatus    PaymentStatus @default(PENDING)
  
  // Order status
  status           OrderStatus   @default(PENDING)
  statusHistory    Json?         // Array of { status, timestamp, note? }
  notes            String?
  
  // Tracking
  estimatedDeliveryDate DateTime?
  trackingNumber        String?
  carrierName           String?   // e.g., "GIG Logistics", "DHL", "KWIK"
  
  // Promo
  promotionId      String?
  promotion        Promotion?    @relation(fields: [promotionId], references: [id])
  
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?

  items            OrderItem[]

  @@map("orders")
  @@index([orderNumber])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2)
  total     Decimal  @db.Decimal(10, 2)
  
  // Snapshot of product details at time of order
  productName  String
  variantSize  String?
  variantColor String?

  @@map("order_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  OPAY_WALLET
  CASH_ON_DELIVERY
}

enum PaymentProvider {
  OPAY
  MONNIFY
  PAYSTACK
}

// ============================================
// SHIPPING
// ============================================

model ShippingZone {
  id        String   @id @default(cuid())
  name      String   @unique
  states    String[] // Array of state names
  fee       Decimal  @db.Decimal(10, 2)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]

  @@map("shipping_zones")
}

// ============================================
// PROMOTIONS
// ============================================

model Promotion {
  id           String        @id @default(cuid())
  code         String        @unique
  name         String
  description  String?
  type         PromotionType
  value        Decimal       @db.Decimal(10, 2) // Percentage or fixed amount
  minOrderAmount Decimal?    @db.Decimal(10, 2)
  maxDiscount  Decimal?      @db.Decimal(10, 2) // Cap for percentage discounts
  usageLimit   Int?
  usageCount   Int           @default(0)
  validFrom    DateTime
  validTo      DateTime
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  orders       Order[]

  @@map("promotions")
}

enum PromotionType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

// ============================================
// SETTINGS
// ============================================

model StoreSettings {
  id          String   @id @default(cuid())
  storeName   String   @default("JFS Wears")
  storeEmail  String   @default("contact@jfswears.com")
  currency    String   @default("NGN")

  // Notifications
  notifyOrder    Boolean @default(true)
  notifyLowStock Boolean @default(true)
  notifyReview   Boolean @default(false)

  updatedAt   DateTime @updatedAt

  @@map("store_settings")
}

// ============================================
// STOREFRONT CMS
// ============================================

model StorefrontHero {
  id           String    @id @default(cuid())
  headline     String
  subheadline  String?
  ctaText      String?   @default("Shop Now")
  ctaLink      String?   // Custom link, or auto-generate from relations

  // Media
  mediaUrl     String
  mediaType    MediaType @default(IMAGE)
  thumbnailUrl String?   // For video previews

  // Optional Relations (polymorphic-like)
  productId    String?
  product      Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  categoryId   String?
  category     Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Display
  order        Int       @default(0)
  isActive     Boolean   @default(true)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("storefront_heroes")
  @@index([order])
  @@index([isActive])
}

model StorefrontSection {
  id          String      @id @default(cuid())
  title       String
  subtitle    String?

  type        SectionType @default(FEATURED)
  
  // For CATEGORY type: which category to show products from
  categoryId  String?
  category    Category?   @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Optional custom media for the section (e.g., hero image for "Hoodies" section)
  mediaUrl    String?
  mediaType   MediaType?

  // Display
  order       Int         @default(0)
  isActive    Boolean     @default(true)
  maxProducts Int         @default(10) // Limit products per section

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("storefront_sections")
  @@index([order])
  @@index([isActive])
}

enum MediaType {
  IMAGE
  VIDEO
}

enum SectionType {
  FEATURED   // Shows featured/latest products
  CATEGORY   // Shows products from a specific category
  COLLECTION // Future: custom curated collection
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  
  // Who performed the action
  staffId     String?
  staff       Staff?   @relation(fields: [staffId], references: [id], onDelete: SetNull)
  staffEmail  String?  // Snapshot in case staff is deleted
  staffName   String?  // Snapshot in case staff is deleted
  
  // What action was performed
  action      AuditAction
  entity      String              // e.g., "Product", "Order", "Staff", "Promotion"
  entityId    String?             // ID of the affected entity
  
  // Details
  description String              // Human-readable description
  metadata    Json?               // Additional data (before/after values, etc.)
  ipAddress   String?             // Client IP address
  userAgent   String?             // Browser/client info
  
  createdAt   DateTime @default(now())

  @@map("audit_logs")
  @@index([staffId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}

enum AuditAction {
  // Auth actions
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  
  // CRUD actions
  CREATE
  UPDATE
  DELETE
  RESTORE
  
  // Order actions
  ORDER_STATUS_UPDATE
  ORDER_CANCEL
  ORDER_REFUND
  
  // System actions
  SETTINGS_UPDATE
  EXPORT_DATA
}

// ============================================
// ADMIN NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  link      String?          // Deep link to related page (e.g., /admin/orders/abc123)
  
  // Target staff (null = broadcast to all admins)
  staffId   String?
  staff     Staff?           @relation(fields: [staffId], references: [id], onDelete: Cascade)
  
  // Read status
  isRead    Boolean          @default(false)
  readAt    DateTime?
  
  // Additional context
  metadata  Json?            // e.g., { orderId, orderNumber, productName }
  
  createdAt DateTime         @default(now())

  @@map("notifications")
  @@index([staffId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  ORDER_NEW
  ORDER_STATUS
  REVIEW_NEW
  LOW_STOCK
  STAFF_LOGIN
}

// ============================================
// BULK PRICING
// ============================================

model BulkPricingTier {
  id              String  @id @default(cuid())
  productId       String
  product         Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  minQuantity     Int     // e.g., 10
  discountPercent Decimal @db.Decimal(5, 2) // e.g., 5.00 for 5%
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([productId, minQuantity])
  @@map("bulk_pricing_tiers")
  @@index([productId])
}
